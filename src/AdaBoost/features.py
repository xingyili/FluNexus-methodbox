import numpy as np
from joblib import Parallel, delayed
from sklearn.preprocessing import OneHotEncoder
from scipy import sparse
class AdaBoostFeature:
    def __init__(self):
        self.GIAG010101 = self.set_GIAG010101()
        self.aa_index = {key: value for value, key in enumerate("ARNDCQEGHILKMFPSTWYV")}

    def get_AAindex_features(self, at, sr):
        AAindex_features_list = []
        for at_site, sr_site in zip(at, sr):
            if at_site == "-" or sr_site == "-":
                m12 = 0
            else:
                m12 = self.GIAG010101[self.aa_index[sr_site]][self.aa_index[at_site]]
            if at_site == "-":
                m11 = 0
            else:
                m11 = self.GIAG010101[self.aa_index[at_site]][self.aa_index[at_site]]
            if sr_site == "-":
                m22 = 0
            else:
                m22 = self.GIAG010101[self.aa_index[sr_site]][self.aa_index[sr_site]]
            g1 = m11 + m22 - 2 * m12
            AAindex_features_list.append(g1)
        return AAindex_features_list
    
    def get_meta_features_for_cross_valid(self, at_name, sr_name, at_ph_type, sr_ph_type):
        ohe = OneHotEncoder(categories=[["cell", "egg"]], handle_unknown='ignore')
        at_ph_type_encoded = ohe.fit_transform( [[x] for x in at_ph_type]).toarray()
        ohe = OneHotEncoder(categories=[["cell", "egg"]], handle_unknown='ignore')
        sr_ph_type_encoded = ohe.fit_transform( [[x] for x in sr_ph_type]).toarray()
        return np.hstack((at_ph_type_encoded, sr_ph_type_encoded))

    def construct_feature(self, at_seqs, sr_seqs, at_name, sr_name, at_ph_type, sr_ph_type, args):
        seq_feature = Parallel(n_jobs=args.n_jobs)(
            delayed(self.get_AAindex_features)(at_seq, sr_seq)
            for at_seq, sr_seq in zip(at_seqs, sr_seqs)
        )
        seq_feature = np.array(seq_feature)
        meta_feature = self.get_meta_features_for_cross_valid(at_name, sr_name, at_ph_type, sr_ph_type)
        return np.hstack((seq_feature, meta_feature))

    def set_GIAG010101(self):
        return [
            [
                0.0,
                -2.4,
                0.5,
                -1.0,
                -0.4,
                -0.1,
                -5.7,
                1.8,
                -0.2,
                -0.8,
                0.5,
                -1.8,
                0.2,
                -0.2,
                -2.0,
                -0.4,
                0.9,
                -0.4,
                -0.4,
                -3.9,
            ],
            [
                2.4,
                0.0,
                2.1,
                0.9,
                0.2,
                2.0,
                0.9,
                0.8,
                0.1,
                0.2,
                0.5,
                3.4,
                0.1,
                -0.5,
                0.5,
                2.2,
                1.3,
                0.2,
                0.2,
                0.7,
            ],
            [
                -0.5,
                -2.1,
                0.0,
                -1.3,
                0.2,
                -0.8,
                -1.9,
                -0.4,
                -0.3,
                -0.2,
                -0.5,
                -2.4,
                -0.2,
                -0.4,
                -0.8,
                -1.3,
                -1.5,
                0.0,
                0.4,
                -0.9,
            ],
            [
                1.0,
                -0.9,
                1.3,
                0.0,
                -0.2,
                -1.2,
                -2.7,
                -1.0,
                -0.2,
                0.0,
                -0.8,
                -0.7,
                0.1,
                -0.1,
                -0.6,
                -0.3,
                1.2,
                -0.2,
                -0.1,
                0.1,
            ],
            [
                0.4,
                -0.2,
                -0.2,
                0.2,
                0.0,
                0.1,
                -0.3,
                -0.3,
                0.1,
                -0.1,
                0.2,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                -0.9,
                -0.1,
                0.1,
                -0.6,
            ],
            [
                0.1,
                -2.0,
                0.8,
                1.2,
                -0.1,
                0.0,
                -1.5,
                -0.5,
                0.4,
                -0.5,
                -1.4,
                -1.9,
                0.5,
                -0.3,
                -0.3,
                0.1,
                0.7,
                -0.2,
                0.0,
                -0.8,
            ],
            [
                5.7,
                -0.9,
                1.9,
                2.7,
                0.3,
                1.5,
                0.0,
                0.0,
                -0.4,
                0.5,
                -0.4,
                -1.7,
                0.4,
                -0.1,
                -0.7,
                2.7,
                2.2,
                -0.2,
                -0.1,
                -0.1,
            ],
            [
                -1.8,
                -0.8,
                0.4,
                1.0,
                0.3,
                0.5,
                0.0,
                0.0,
                0.2,
                0.0,
                -0.1,
                -0.5,
                0.4,
                -0.5,
                -0.2,
                0.1,
                -0.1,
                -0.1,
                0.3,
                0.4,
            ],
            [
                0.2,
                -0.1,
                0.3,
                0.2,
                -0.1,
                -0.4,
                0.4,
                -0.2,
                0.0,
                0.1,
                0.3,
                -0.4,
                0.0,
                -0.5,
                0.2,
                0.3,
                0.0,
                -0.3,
                -0.3,
                0.1,
            ],
            [
                0.8,
                -0.2,
                0.2,
                0.0,
                0.1,
                0.5,
                -0.5,
                0.0,
                -0.1,
                0.0,
                -0.3,
                -0.6,
                1.3,
                -0.2,
                0.2,
                0.3,
                0.8,
                -0.5,
                0.0,
                -2.1,
            ],
            [
                -0.5,
                -0.5,
                0.5,
                0.8,
                -0.2,
                1.4,
                0.4,
                0.1,
                -0.3,
                0.3,
                0.0,
                -0.7,
                0.2,
                -1.0,
                0.6,
                -0.1,
                -0.1,
                0.1,
                -0.7,
                0.1,
            ],
            [
                1.8,
                -3.4,
                2.4,
                0.7,
                0.0,
                1.9,
                1.7,
                0.5,
                0.4,
                0.6,
                0.7,
                0.0,
                0.8,
                -0.7,
                0.1,
                2.6,
                1.4,
                0.0,
                0.1,
                1.1,
            ],
            [
                -0.2,
                -0.1,
                0.2,
                -0.1,
                0.0,
                -0.5,
                -0.4,
                -0.4,
                0.0,
                -1.3,
                -0.2,
                -0.8,
                0.0,
                0.3,
                -0.2,
                -0.2,
                0.1,
                0.2,
                -0.1,
                -1.0,
            ],
            [
                0.2,
                0.5,
                0.4,
                0.1,
                0.0,
                0.3,
                0.1,
                0.5,
                0.5,
                0.2,
                1.0,
                0.7,
                -0.3,
                0.0,
                0.0,
                0.5,
                -0.8,
                -0.7,
                0.5,
                0.3,
            ],
            [
                2.0,
                -0.5,
                0.8,
                0.6,
                0.0,
                0.3,
                0.7,
                0.2,
                -0.2,
                -0.2,
                -0.6,
                -0.1,
                0.2,
                0.0,
                0.0,
                1.8,
                0.5,
                -0.1,
                0.1,
                0.2,
            ],
            [
                0.4,
                -2.2,
                1.3,
                0.3,
                0.0,
                -0.1,
                -2.7,
                -0.1,
                -0.3,
                -0.3,
                0.1,
                -2.6,
                0.2,
                -0.5,
                -1.8,
                0.0,
                -1.6,
                -0.1,
                -0.1,
                0.0,
            ],
            [
                -0.9,
                -1.3,
                1.5,
                -1.2,
                0.9,
                -0.7,
                -2.2,
                0.1,
                0.0,
                -0.8,
                0.1,
                -1.4,
                -0.1,
                0.8,
                -0.5,
                1.6,
                0.0,
                -0.4,
                0.4,
                -1.5,
            ],
            [
                0.4,
                -0.2,
                0.0,
                0.2,
                0.1,
                0.2,
                0.2,
                0.1,
                0.3,
                0.5,
                -0.1,
                0.0,
                -0.2,
                0.7,
                0.1,
                0.1,
                0.4,
                0.0,
                -0.2,
                0.1,
            ],
            [
                0.4,
                -0.2,
                -0.4,
                0.1,
                -0.1,
                0.0,
                0.1,
                -0.3,
                0.3,
                0.0,
                0.7,
                -0.1,
                0.1,
                -0.5,
                -0.1,
                0.1,
                -0.4,
                0.2,
                0.0,
                -0.1,
            ],
            [
                3.9,
                -0.7,
                0.9,
                -0.1,
                0.6,
                0.8,
                0.1,
                -0.4,
                -0.1,
                2.1,
                -0.1,
                -1.1,
                1.0,
                -0.3,
                -0.2,
                0.0,
                1.5,
                -0.1,
                0.1,
                0.0,
            ],
        ]
